<html layout:decorate="~{layout}">
    <div layout:fragment="content">
        <div th:if="${#lists.isEmpty(baskets)}">
            <p>장바구니가 비어 있습니다.</p>
            <a href="/main">상품 보러가기</a>
        </div>
        <div th:unless="${#lists.isEmpty(baskets)}">
            <div th:each="basket: ${baskets}">
                <h1>구매 페이지</h1>
                <img th:src="|/${basket.productImage}/|" class="card-img-top" alt="이미지를 불러올 수 없습니다.">
                <!-- 상품 이름 -->
                <p th:text="${basket.productName}" th:id="productName"></p>
                <!-- 상품 가격 -->
                <p th:text="${basket.productPrice}" th:id="productPrice"></p>
                <!-- 상품 설명 -->
                <p th:text="${basket.productDescription}" th:id="productDescription"></p>
                <!-- 선택된 개수 -->
                <p th:text="${basket.selectedQuantity}" th:id="selectedQuantity"></p>
                <!-- 상품 기타 -->
                <p th:text="${basket.productEtc}" th:id="productEtc"></p>
                <!-- 선택된 상품 가격 -->
                <p th:text="${basket.basketPrice}" th:id="basketPrice"></p>
                <a href="javascript:void(0);" class="delete" th:data-uri="@{|/main/basket/${basket.basketId}|}" sec:authorize="isAuthenticated()" th:if="${basket.username != null and #authentication.getPrincipal().getUsername() == basket.username}" th:text="삭제"></a>
            </div>
            <!-- 장바구니 모든 가격 -->
            <p th:text="${totalPrice.totalPrice}" th:id="totalPrice"></p>
        </div>
        <button onclick="requestPay()">결제하기</button>
    </div>

    <script layout:fragment="script" type="text/javascript">
        const delete_elements = document.getElementsByClassName("delete");
        Array.from(delete_elements).forEach(function(element) {
            element.addEventListener('click', function() {
                if(confirm("정말로 삭제하시겠습니까?")) {
                    location.href = this.dataset.uri;
            };
        });
    });
    </script>

    <script layout:fragment="payment" type="text/javascript">
        var IMP = window.IMP;
        IMP.init("imp83026887");

        var productName = $('#productName').text();
        var totalPrice = $('#totalPrice').text();

        function requestPay() {
            IMP.request_pay(
                {
                    pg: "html5_inicis",
                    pay_method: "card",
                    merchant_uid: "",
                    name: productName,
                    amount: totalPrice,
      				buyer_email: "gildong@gmail.com",
      				buyer_name: "홍길동",
      				buyer_tel: "010-4242-4242",
      				buyer_addr: "서울특별시 강남구 신사동",
      				buyer_postcode: "01181"

                },
                function (rsp) {
      				//rsp.imp_uid 값으로 결제 단건조회 API를 호출하여 결제결과를 판단합니다.
                    if (rsp.success) {
                        //서버 검증 요청 부분
                    } else {
                        alert(rsp.error_msg);
                    }
                }
            );
        }
    </script>
</html>